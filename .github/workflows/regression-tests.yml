name: Regression Tests

on:
  pull_request:
    types: [opened, synchronize]  # Trigger on new PR and existing with new commits
    branches:
      - develop

jobs:
  deploy_devnet:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cdk-validium-node
        uses: actions/checkout@v4
        with:
          path: cdk-validium-node

      - name: Checkout kurtosis-cdk
        uses: actions/checkout@v4
        with:
          repository: 0xPolygon/kurtosis-cdk
          ref: v0.2.2
          path: kurtosis-cdk

      - name: Install Kurtosis CDK tools
        uses: ./kurtosis-cdk/.github/actions/setup-kurtosis-cdk

      - name: Build docker image
        working-directory: ./cdk-validium-node
        run: docker build -t cdk-validium-node:local --file Dockerfile .

      - name: Configure Kurtosis CDK
        working-directory: ./kurtosis-cdk
        run: |
          yq -Y --in-place '.args.data_availability_mode = "rollup"' params.yml
          yq -Y --in-place '.args.zkevm_node_image = "cdk-validium-node:local"' params.yml

      - name: Deploy Kurtosis CDK package
        working-directory: ./kurtosis-cdk
        run: kurtosis run --enclave cdk-v1 --args-file params.yml --image-download always .

      - name: Monitor verified batches
        working-directory: ./kurtosis-cdk
        shell: bash
        run: .github/actions/monitor-cdk-verified-batches/batch_verification_monitor.sh 20 600
