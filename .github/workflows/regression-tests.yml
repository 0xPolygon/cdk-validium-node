name: Regression Tests

on:
  pull_request:
    types: [opened, synchronize]  # Trigger on new PR and existing with new commits
    branches:
      - develop

jobs:
  kurtosis-cdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cdk-validium-node
        uses: actions/checkout@v4
        with:
          repository: 0xPolygon/cdk-validium-node
          #ref: d8e6026f84709e63e0d59a52a456de4b2e6e3778
          #ref: 1937eaf00dfa999c0322602f292f2789ef7b2b89
          #ref: 8032cb1e4b7b961817fd8bd096923032ea440b11
          #ref: 33e1b0f1852b6bf827c3aacfcd8f2949b8f71457
          ref: 404088f92bbf21c443984414d0d50a5de0db2837
          #ref: e74a227ccbb6ec7cd587103f035c16316d59b4fc
          #ref: 694351727b5aa8ce4eb9e50bb26412b7d596d0f6
          #ref: bd59114567b8de98374168f1fd5901355e5c5637
          path: cdk-validium-node

      - name: Checkout kurtosis-cdk
        uses: actions/checkout@v4
        with:
          repository: 0xPolygon/kurtosis-cdk
          ref: v0.2.2
          path: kurtosis-cdk

      - name: Install Kurtosis CDK tools
        uses: ./kurtosis-cdk/.github/actions/setup-kurtosis-cdk

      - name: Build docker image
        working-directory: ./cdk-validium-node
        run: docker build -t cdk-validium-node:local --file Dockerfile .

      - name: Configure Kurtosis CDK
        working-directory: ./kurtosis-cdk
        run: |
          yq -Y --in-place '.args.data_availability_mode = "cdk-validium"' params.yml
          yq -Y --in-place '.args.cdk_node_image = "cdk-validium-node:local"' params.yml

      - name: Deploy Kurtosis CDK package
        working-directory: ./kurtosis-cdk
        run: kurtosis run --enclave cdk-v1 --args-file params.yml --image-download always .

      - name: Monitor verified batches
        working-directory: ./kurtosis-cdk
        shell: bash
        run: .github/actions/monitor-cdk-verified-batches/batch_verification_monitor.sh 20 600
